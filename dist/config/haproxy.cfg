global
    log stdout format raw local0
    maxconn 4096
    user haproxy
    group haproxy

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  http-server-close
    option  forwardfor
    timeout connect 5000
    timeout client  50000
    timeout server  50000

frontend http-in
    bind *:80
    mode http
    option forwardfor
    http-request set-header X-Forwarded-Proto http
    http-request redirect scheme https unless { ssl_fc }

frontend https-in
    bind *:443 ssl crt /usr/local/etc/haproxy/cert.pem
    mode http
    option forwardfor

    http-request set-header X-Forwarded-Proto https

    acl is_frontend  ssl_fc_sni -i 2bgp-ctf.vpws.eu
    acl is_api       ssl_fc_sni -i api.2bgp-ctf.vpws.eu
    acl is_target1   ssl_fc_sni -i target1.2bgp-ctf.vpws.eu
    acl is_target2   ssl_fc_sni -i target2.2bgp-ctf.vpws.eu
    acl is_target3   ssl_fc_sni -i target3.2bgp-ctf.vpws.eu
    acl is_target4   ssl_fc_sni -i target4.2bgp-ctf.vpws.eu
    acl is_target5   ssl_fc_sni -i target5.2bgp-ctf.vpws.eu
    acl is_target6   ssl_fc_sni -i target6.2bgp-ctf.vpws.eu
    acl is_target7   ssl_fc_sni -i target7.2bgp-ctf.vpws.eu
    acl is_target8   ssl_fc_sni -i target8.2bgp-ctf.vpws.eu
    acl is_target9   ssl_fc_sni -i target9.2bgp-ctf.vpws.eu
    acl is_target10  ssl_fc_sni -i target10.2bgp-ctf.vpws.eu

    use_backend backend_frontend if is_frontend
    use_backend backend_api if is_api
    use_backend backend_target1 if is_target1
    use_backend backend_target2 if is_target2
    use_backend backend_target3 if is_target3
    use_backend backend_target4 if is_target4
    use_backend backend_target5 if is_target5
    use_backend backend_target6 if is_target6
    use_backend backend_target7 if is_target7
    use_backend backend_target8 if is_target8
    use_backend backend_target9 if is_target9
    use_backend backend_target10 if is_target10

    default_backend backend_frontend

backend backend_frontend
    server frontend frontend:80 check

backend backend_api
    server backend backend:3000 check

backend backend_target1
    server level1 level1:80 check

backend backend_target2
    server level2 level2:80 check

backend backend_target3
    server level3 level3:80 check

backend backend_target4
    server level4 level4:80 check

backend backend_target5
    server level5 level5:80 check

backend backend_target6
    server level6 level6:80 check

backend backend_target7
    server level7 level7:80 check

backend backend_target8
    server level8 level8:80 check

backend backend_target9
    server level9 level9:80 check

backend backend_target10
    server level10 level10:80 check
