services:

# Level management

  backend:
    image: 2bgp-ctf_backend
    container_name: backend
    ports:
      - "3000:3000"
    env_file:
      - config/backend.env
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/levels"]
      interval: 2s
      timeout: 1s
      retries: 3
      start_period: 3s

  frontend:
    image: 2bgp-ctf_frontend
    container_name: frontend
    ports:
      - "80:80"
    depends_on:
      backend:
        condition: service_healthy

  mongodb:
    image: mongo
    container_name: mongodb
    volumes:
      - mongodata:/data/db
    env_file:
      - config/mongodb.env

  deploy:
    image: curlimages/curl
    container_name: deploy-script
    volumes:
      - ./scripts/deploy_levels.sh:/scripts/deploy_levels.sh
      - ./config/backend.env:/scripts/config/backend.env
    command: ["sh", "/scripts/deploy_levels.sh"]
    depends_on:
      backend:
        condition: service_healthy


# Levels

  level2:
    image: 2bgp-ctf_level2
    container_name: level2
    ports:
      - "81:80"
    

volumes:
  mongodata:
    external: false