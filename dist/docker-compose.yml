services:

### Level management
# Backend
  backend:
    image: 2bgp-ctf_backend
    container_name: backend
    ports:
      - "3000:3000"
    env_file:
      - config/backend.env
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/levels"]
      interval: 2s
      timeout: 1s
      retries: 3
      start_period: 3s

# Frontend
  frontend:
    image: 2bgp-ctf_frontend
    container_name: frontend
    ports:
      - "80:80"
    depends_on:
      backend:
        condition: service_healthy

# MongoDB Database
  mongodb:
    image: mongo
    container_name: mongodb
    volumes:
      - mongodata:/data/db
    env_file:
      - config/mongodb.env

# Deploy scripts
  deploy:
    image: curlimages/curl
    container_name: deploy
    volumes:
      - ./scripts/deploy_levels.sh:/scripts/deploy_levels.sh
      - ./config/backend.env:/scripts/config/backend.env
    command: ["sh", "/scripts/deploy_levels.sh"]
    depends_on:
      backend:
        condition: service_healthy


### Levels

# Database
  mysql:
    image: mysql:latest
    container_name: mysql
    environment:
      MYSQL_ROOT_PASSWORD: manicure-handbrake-cadet # Useless
    volumes:
      - ./scripts/deploy_db.sql:/docker-entrypoint-initdb.d/init.sql

# Level 1
  level1:
    image: 2bgp-ctf_level1
    container_name: level1
    depends_on:
      backend:
        condition: service_healthy   

# Level 2
  level2:
    image: 2bgp-ctf_level2
    container_name: level2
    depends_on:
      backend:
        condition: service_healthy

# Level 3
  level3:
    image: 2bgp-ctf_level3
    container_name: level3
    depends_on:
      backend:
        condition: service_healthy

# Level 4
  level4:
    image: 2bgp-ctf_level4
    container_name: level4
    depends_on:
      backend:
        condition: service_healthy

# Level 5
  level5:
    image: 2bgp-ctf_level5
    container_name: level5
    depends_on:
      backend:
        condition: service_healthy

# Level 6
  level6:
    image: 2bgp-ctf_level6
    container_name: level6
    depends_on:
      backend:
        condition: service_healthy

# Level 7
  level7:
    image: 2bgp-ctf_level7
    container_name: level7
    depends_on:
      backend:
        condition: service_healthy

# Level 8
  level8:
    image: 2bgp-ctf_level8
    container_name: level8
    depends_on:
      backend:
        condition: service_healthy

# Level 9
  level9:
    image: 2bgp-ctf_level9
    container_name: level9
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - "81:80" 
    

volumes:
  mongodata:
    external: false